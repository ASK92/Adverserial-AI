"""
Generate a visually distinct malware attack patch.
This patch should look very different from the Boo patch to avoid confusion.
"""
import numpy as np
import cv2
from PIL import Image, ImageDraw, ImageFont
import torch

def create_malware_patch(output_path='data/patches/malware_attack_patch.png', size=224):
    """
    Create a visually distinct malware patch with:
    - Red/black color scheme (different from typical Boo patch colors)
    - Distinct geometric patterns
    - Warning symbols or malware indicators
    - High contrast design
    """
    # Create a base image with red/black theme (very different from typical patches)
    img = np.zeros((size, size, 3), dtype=np.uint8)
    
    # Fill with dark red background
    img[:, :] = [30, 0, 0]  # Dark red
    
    # Add bright red diagonal stripes
    for i in range(0, size, 20):
        cv2.line(img, (i, 0), (i + size, size), (255, 0, 0), 3)
        cv2.line(img, (0, i), (size, i + size), (255, 0, 0), 3)
    
    # Add black warning triangle in center
    center = size // 2
    triangle_size = 80
    triangle_points = np.array([
        [center, center - triangle_size],
        [center - triangle_size, center + triangle_size // 2],
        [center + triangle_size, center + triangle_size // 2]
    ], np.int32)
    cv2.fillPoly(img, [triangle_points], (0, 0, 0))
    
    # Add exclamation mark in triangle (white)
    cv2.line(img, (center, center - 20), (center, center + 10), (255, 255, 255), 8)
    cv2.circle(img, (center, center + 25), 5, (255, 255, 255), -1)
    
    # Add red border
    cv2.rectangle(img, (5, 5), (size - 5, size - 5), (255, 0, 0), 5)
    
    # Add corner markers (distinctive pattern)
    marker_size = 15
    # Top-left corner
    cv2.rectangle(img, (10, 10), (10 + marker_size, 10 + marker_size), (255, 255, 0), 2)
    # Top-right corner
    cv2.rectangle(img, (size - 10 - marker_size, 10), (size - 10, 10 + marker_size), (255, 255, 0), 2)
    # Bottom-left corner
    cv2.rectangle(img, (10, size - 10 - marker_size), (10 + marker_size, size - 10), (255, 255, 0), 2)
    # Bottom-right corner
    cv2.rectangle(img, (size - 10 - marker_size, size - 10 - marker_size), (size - 10, size - 10), (255, 255, 0), 2)
    
    # Add some high-frequency noise patterns (distinctive)
    noise = np.random.randint(0, 50, (size, size, 3), dtype=np.uint8)
    mask = np.random.random((size, size)) > 0.95  # Sparse noise
    img[mask] = np.clip(img[mask].astype(int) + noise[mask], 0, 255).astype(np.uint8)
    
    # Convert to PIL Image and save
    pil_img = Image.fromarray(cv2.cvtColor(img, cv2.COLOR_BGR2RGB))
    pil_img.save(output_path)
    print(f"Created visually distinct malware patch: {output_path}")
    print(f"   - Red/black color scheme (different from Boo patch)")
    print(f"   - Warning triangle with exclamation mark")
    print(f"   - Yellow corner markers")
    print(f"   - Diagonal red stripes")
    
    return img

if __name__ == "__main__":
    import os
    os.makedirs('data/patches', exist_ok=True)
    create_malware_patch()

